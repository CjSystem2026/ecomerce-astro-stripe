---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout
  title="Tu Carrito — MiTienda"
  description="Revisa los productos en tu carrito y finaliza tu compra."
>
  <section class="section">
    <div class="container">
      <h1 class="section-title">Tu Carrito</h1>

      <div class="cart-layout" id="cart-container">
        <!-- Cargando carrito vía JS client-side -->
        <div class="loading-state">Cargando tu carrito...</div>
      </div>
    </div>
  </section>
</MainLayout>

<script>
  interface CartItem {
    id: string;
    name: string;
    price: string;
    image: string;
    qty: string;
  }

  function renderCart() {
    const cartContainer = document.getElementById("cart-container");
    if (!cartContainer) return;

    const cart: CartItem[] = JSON.parse(localStorage.getItem("cart") ?? "[]");

    if (cart.length === 0) {
      cartContainer.innerHTML = `
            <div class="empty-cart">
              <p>Tu carrito está vacío.</p>
              <a href="/productos" class="btn btn--primary">Ir a la tienda</a>
            </div>
          `;
      return;
    }

    const total = cart.reduce(
      (acc, item) => acc + Number(item.price) * Number(item.qty),
      0,
    );

    cartContainer.innerHTML = `
          <div class="cart-grid">
            <div class="cart-items">
              ${cart
                .map(
                  (item) => `
                <div class="cart-item" data-id="${item.id}">
                  <img src="${item.image}" alt="${item.name}" class="cart-item__img" />
                  <div class="cart-item__info">
                    <h3>${item.name}</h3>
                    <p>S/ ${Number(item.price).toFixed(2)}</p>
                  </div>
                  <div class="cart-item__qty">
                    <button class="qty-btn" onclick="updateQty('${item.id}', -1)">−</button>
                    <span>${item.qty}</span>
                    <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                  </div>
                  <div class="cart-item__subtotal">
                    S/ ${(Number(item.price) * Number(item.qty)).toFixed(2)}
                  </div>
                  <button class="remove-btn" onclick="removeItem('${item.id}')">✕</button>
                </div>
              `,
                )
                .join("")}
            </div>
            <div class="cart-summary">
              <h2>Resumen</h2>
              <div class="summary-row">
                <span>Subtotal</span>
                <span>S/ ${total.toFixed(2)}</span>
              </div>
              <div class="summary-row">
                <span>Envío</span>
                <span>Gratis</span>
              </div>
              <div class="summary-total">
                <span>Total</span>
                <span>S/ ${total.toFixed(2)}</span>
              </div>
              <button class="btn btn--primary btn--full" onclick="checkout()">Finalizar Compra</button>
            </div>
          </div>
        `;
  }

  // Hacer funciones globales para onclick
  (window as any).updateQty = (id: string, delta: number) => {
    let cart: CartItem[] = JSON.parse(localStorage.getItem("cart") ?? "[]");
    const item = cart.find((i) => i.id === id);
    if (item) {
      const newQty = Number(item.qty) + delta;
      if (newQty > 0) {
        item.qty = String(newQty);
      } else {
        cart = cart.filter((i) => i.id !== id);
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      window.dispatchEvent(new Event("storage")); // Notificar al header
    }
  };

  (window as any).removeItem = (id: string) => {
    let cart: CartItem[] = JSON.parse(localStorage.getItem("cart") ?? "[]");
    cart = cart.filter((i) => i.id !== id);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    window.dispatchEvent(new Event("storage"));
  };

  (window as any).checkout = () => {
    window.location.href = "/checkout";
  };

  // Escuchar eventos de navegación de View Transitions
  document.addEventListener("astro:page-load", renderCart);
</script>

<style>
  .cart-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 2rem;
    align-items: start;
  }

  .cart-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cart-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: var(--surface);
    padding: 1.25rem;
    border-radius: 16px;
    border: 1px solid var(--border);
  }

  .cart-item__img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-item__info {
    flex: 1;
  }
  .cart-item__info h3 {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
  }

  .cart-item__qty {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: var(--surface-2);
    padding: 0.5rem;
    border-radius: 8px;
  }

  .qty-btn {
    background: none;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0 0.5rem;
  }

  .cart-item__subtotal {
    font-weight: 700;
    min-width: 100px;
    text-align: right;
  }

  .remove-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.5rem;
  }

  .remove-btn:hover {
    color: var(--accent);
  }

  .cart-summary {
    background: var(--surface);
    padding: 2rem;
    border-radius: 16px;
    border: 1px solid var(--border);
    position: sticky;
    top: 100px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin: 1rem 0;
    color: var(--text-muted);
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
    border-top: 1px solid var(--border);
    padding-top: 1.5rem;
    font-weight: 800;
    font-size: 1.25rem;
  }

  .btn--full {
    width: 100%;
    margin-top: 1.5rem;
    justify-content: center;
  }

  .empty-cart {
    text-align: center;
    padding: 5rem;
    background: var(--surface);
    border-radius: 20px;
  }

  @media (max-width: 900px) {
    .cart-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
