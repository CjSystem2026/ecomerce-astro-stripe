---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout
  title="Tu Carrito â€” MiTienda"
  description="Revisa los productos en tu carrito y finaliza tu compra."
>
  <section class="cart-section">
    <div class="container">
      <!-- Header -->
      <div class="cart-header">
        <a href="/productos" class="back-link">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
          >
          Seguir comprando
        </a>
        <h1>Tu Carrito</h1>
      </div>

      <!-- Main layout renderizado por JS -->
      <div id="cart-root">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Cargando tu carrito...</p>
        </div>
      </div>
    </div>
  </section>
</MainLayout>

<script>
  interface CartItem {
    id: string;
    name: string;
    price: string;
    image: string;
    qty: string;
  }

  function renderCart() {
    const root = document.getElementById("cart-root");
    if (!root) return;

    let cart: CartItem[] = [];
    try {
      cart = JSON.parse(localStorage.getItem("cart") ?? "[]");
    } catch (e) {
      cart = [];
    }

    // â€” Estado vacÃ­o â€”
    if (cart.length === 0) {
      root.innerHTML = `
        <div class="empty-cart">
          <div class="empty-icon">ðŸ›’</div>
          <h2>Tu carrito estÃ¡ vacÃ­o</h2>
          <p>Explora nuestro catÃ¡logo y encuentra algo que te guste.</p>
          <a href="/productos" class="btn-checkout">Ir a la tienda</a>
        </div>
      `;
      return;
    }

    const total = cart.reduce(
      (acc, item) => acc + Number(item.price) * Number(item.qty),
      0,
    );
    const itemCount = cart.reduce((acc, item) => acc + Number(item.qty), 0);

    root.innerHTML = `
      <div class="cart-layout">

        <!-- Lista de productos -->
        <div class="cart-items-wrapper">
          <div class="cart-items-header">
            <span>Producto</span>
            <span>Cantidad</span>
            <span>Precio</span>
          </div>
          <div class="cart-items" id="cart-items-list">
            ${cart
              .map(
                (item) => `
              <div class="cart-item" data-id="${item.id}">
                <div class="cart-item__product">
                  <img src="${item.image}" alt="${item.name}" class="cart-item__img" />
                  <div class="cart-item__info">
                    <h3 class="cart-item__name">${item.name}</h3>
                    <p class="cart-item__unit-price">S/ ${Number(item.price).toFixed(2)} c/u</p>
                  </div>
                </div>

                <div class="cart-item__qty-control">
                  <button class="qty-btn" onclick="updateQty('${item.id}', -1)" aria-label="Disminuir cantidad">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                  </button>
                  <span class="qty-value">${item.qty}</span>
                  <button class="qty-btn" onclick="updateQty('${item.id}', 1)" aria-label="Aumentar cantidad">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                  </button>
                </div>

                <div class="cart-item__right">
                  <span class="cart-item__subtotal">S/ ${(Number(item.price) * Number(item.qty)).toFixed(2)}</span>
                  <button class="remove-btn" onclick="removeItem('${item.id}')" aria-label="Eliminar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
                  </button>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
        </div>

        <!-- Panel de resumen (como en Stitch) -->
        <aside class="cart-summary">
          <h2 class="summary-title">Resumen del pedido</h2>
          <p class="summary-count">${itemCount} ${itemCount === 1 ? "producto" : "productos"}</p>

          <div class="summary-lines">
            <div class="summary-line">
              <span>Subtotal</span>
              <span>S/ ${total.toFixed(2)}</span>
            </div>
            <div class="summary-line">
              <span>EnvÃ­o</span>
              <span class="free-badge">Gratis</span>
            </div>
          </div>

          <div class="summary-total-row">
            <span>Total</span>
            <span class="total-amount">S/ ${total.toFixed(2)}</span>
          </div>

          <button class="btn-checkout" onclick="checkout()">
            Finalizar Compra
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
          </button>

          <!-- Trust badges (estilo Stitch) -->
          <div class="trust-badges">
            <div class="trust-badge">
              <div class="trust-badge__icon">ðŸšš</div>
              <div class="trust-badge__text">
                <strong>EnvÃ­o RÃ¡pido</strong>
                <span>Delivery gratis a todo Lima</span>
              </div>
            </div>
            <div class="trust-badge">
              <div class="trust-badge__icon">ðŸ”’</div>
              <div class="trust-badge__text">
                <strong>Pago Seguro</strong>
                <span>Tus datos siempre protegidos</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    `;
  }

  (window as any).updateQty = (id: string, delta: number) => {
    let cart: CartItem[] = JSON.parse(localStorage.getItem("cart") ?? "[]");
    const item = cart.find((i) => i.id === id);
    if (item) {
      const newQty = Number(item.qty) + delta;
      if (newQty > 0) item.qty = String(newQty);
      else cart = cart.filter((i) => i.id !== id);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      window.dispatchEvent(new Event("storage"));
    }
  };

  (window as any).removeItem = (id: string) => {
    let cart: CartItem[] = JSON.parse(localStorage.getItem("cart") ?? "[]");
    cart = cart.filter((i) => i.id !== id);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    window.dispatchEvent(new Event("storage"));
  };

  (window as any).checkout = () => {
    window.location.href = "/checkout";
  };

  document.addEventListener("astro:page-load", renderCart);
</script>

<style>
  .cart-section {
    padding: 3rem 0 5rem;
  }

  /* Header */
  .cart-header {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2.5rem;
  }

  .cart-header h1 {
    font-size: clamp(1.6rem, 3vw, 2.4rem);
    font-weight: 800;
    letter-spacing: -0.02em;
    margin: 0;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.2s;
    white-space: nowrap;
  }
  .back-link:hover {
    color: var(--primary);
  }

  /* Layout */
  .cart-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 2.5rem;
    align-items: start;
  }

  /* Items wrapper */
  .cart-items-wrapper {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .cart-items-header {
    display: grid;
    grid-template-columns: 1fr 140px 130px;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--text-muted);
  }

  /* Cada producto */
  .cart-item {
    display: grid;
    grid-template-columns: 1fr 140px 130px;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }
  .cart-item:last-child {
    border-bottom: none;
  }
  .cart-item:hover {
    background: var(--surface-2);
  }

  .cart-item__product {
    display: flex;
    align-items: center;
    gap: 1.25rem;
  }

  .cart-item__img {
    width: 72px;
    height: 72px;
    object-fit: cover;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    flex-shrink: 0;
  }

  .cart-item__name {
    font-size: 0.95rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    line-height: 1.3;
  }

  .cart-item__unit-price {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin: 0;
  }

  /* Controles de cantidad */
  .cart-item__qty-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    width: fit-content;
  }

  .qty-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.1rem;
    transition: color 0.2s;
    line-height: 1;
  }
  .qty-btn:hover {
    color: var(--primary);
  }

  .qty-value {
    font-weight: 700;
    font-size: 0.95rem;
    min-width: 1.5rem;
    text-align: center;
  }

  /* Derecha: precio + eliminar */
  .cart-item__right {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .cart-item__subtotal {
    font-weight: 800;
    font-size: 1rem;
  }

  .remove-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    padding: 0.4rem;
    border-radius: 8px;
    transition: all 0.2s;
  }
  .remove-btn:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.08);
  }

  /* Panel de resumen */
  .cart-summary {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: 2rem;
    position: sticky;
    top: 100px;
  }

  .summary-title {
    font-size: 1.2rem;
    font-weight: 800;
    margin: 0 0 0.25rem;
  }

  .summary-count {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0 0 1.5rem;
  }

  .summary-lines {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.25rem;
  }

  .summary-line {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .free-badge {
    color: #16a34a;
    font-weight: 700;
    font-size: 0.85rem;
  }

  .summary-total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    font-weight: 700;
    font-size: 1rem;
  }

  .total-amount {
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: var(--primary);
  }

  .btn-checkout {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    width: 100%;
    padding: 1rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 20px rgba(236, 55, 19, 0.2);
  }
  .btn-checkout:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(236, 55, 19, 0.3);
  }
  .btn-checkout:active {
    transform: scale(0.98);
  }

  /* Trust Badges (al estilo Stitch) */
  .trust-badges {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .trust-badge__icon {
    font-size: 1.4rem;
    flex-shrink: 0;
  }

  .trust-badge__text {
    display: flex;
    flex-direction: column;
  }

  .trust-badge__text strong {
    font-size: 0.85rem;
    font-weight: 700;
  }

  .trust-badge__text span {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  /* Estado vacÃ­o */
  .empty-cart {
    text-align: center;
    padding: 5rem 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .empty-icon {
    font-size: 3.5rem;
  }

  .empty-cart h2 {
    font-size: 1.5rem;
    font-weight: 800;
    margin: 0;
  }

  .empty-cart p {
    color: var(--text-muted);
    max-width: 320px;
    margin: 0;
  }

  /* Loading */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 5rem;
    color: var(--text-muted);
  }

  .loading-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .cart-layout {
      grid-template-columns: 1fr;
    }
    .cart-items-header {
      display: none;
    }
    .cart-item {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    .cart-item__right {
      justify-content: space-between;
    }
    .cart-summary {
      position: static;
    }
  }
</style>
