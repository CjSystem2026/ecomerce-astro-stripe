---
export const prerender = false; // SSR — dinámica por slug

import MainLayout from "@/layouts/MainLayout.astro";
import {
  getProductBySlug,
  getStrapiImageUrl,
  blocksToPlainText,
} from "@/lib/strapi";

const { slug } = Astro.params;
const product = await getProductBySlug(slug!);

if (!product) {
  return Astro.redirect("/404");
}

const productImg = Array.isArray(product.imagen)
  ? product.imagen[0]
  : product.imagen;
const imageUrl = getStrapiImageUrl(productImg?.url);
const hasDiscount =
  product.precioOferta && product.precioOferta < product.precio;
const discountPercent = hasDiscount
  ? Math.round(
      ((product.precio - product.precioOferta!) / product.precio) * 100,
    )
  : 0;
const finalPrice = hasDiscount ? product.precioOferta! : product.precio;
---

<MainLayout
  title={`${product.nombre} — MiTienda`}
  description={blocksToPlainText(product.descripcion).slice(0, 160)}
  image={imageUrl}
>
  <article class="product-detail">
    <div class="container">
      <nav class="breadcrumb" aria-label="Ruta de navegación">
        <a href="/">Inicio</a>
        <span>/</span>
        <a href="/productos">Productos</a>
        {
          product.categoria && (
            <>
              <span>/</span>
              <a href={`/categorias/${product.categoria.slug}`}>
                {product.categoria.nombre}
              </a>
            </>
          )
        }
        <span>/</span>
        <span aria-current="page">{product.nombre}</span>
      </nav>

      <div class="product-detail__grid">
        <!-- Imagen -->
        <div class="product-detail__gallery">
          <div class="product-detail__main-image">
            <img
              src={imageUrl}
              alt={productImg?.alternativeText ?? product.nombre}
              width="600"
              height="600"
            />
            {
              hasDiscount && (
                <span class="badge badge--discount">-{discountPercent}%</span>
              )
            }
          </div>
        </div>

        <!-- Info -->
        <div class="product-detail__info">
          {
            product.categoria && (
              <a
                href={`/categorias/${product.categoria.slug}`}
                class="product-detail__category"
              >
                {product.categoria.nombre}
              </a>
            )
          }

          <h1 class="product-detail__title">{product.nombre}</h1>

          <!-- Precio -->
          <div class="product-detail__pricing">
            <span class="price price--main">S/ {finalPrice.toFixed(2)}</span>
            {
              hasDiscount && (
                <span class="price price--original">
                  S/ {product.precio.toFixed(2)}
                </span>
              )
            }
          </div>

          <!-- Descripción -->
          <div class="product-detail__desc">
            {
              Array.isArray(product.descripcion) ? (
                product.descripcion.map((block: any) => (
                  <p>{block.children?.map((c: any) => c.text).join("")}</p>
                ))
              ) : (
                <p>
                  {product.descripcion ||
                    "Este producto no tiene una descripción disponible."}
                </p>
              )
            }
          </div>

          <!-- Stock -->
          <div class="product-detail__stock">
            {
              product.stock > 0 ? (
                <span class="stock stock--ok">
                  ✓ En stock ({product.stock} disponibles)
                </span>
              ) : (
                <span class="stock stock--out">✗ Sin stock</span>
              )
            }
          </div>

          <!-- Cantidad + Carrito -->
          <div class="product-detail__actions">
            <div class="qty-selector">
              <button
                class="qty-btn"
                id="qty-minus"
                aria-label="Disminuir cantidad">−</button
              >
              <input
                type="number"
                id="qty-input"
                class="qty-input"
                value="1"
                min="1"
                max={product.stock}
                readonly
              />
              <button
                class="qty-btn"
                id="qty-plus"
                aria-label="Aumentar cantidad">+</button
              >
            </div>

            <button
              class="btn-add-cart"
              id="add-to-cart"
              data-product-id={product.documentId}
              data-product-name={product.nombre}
              data-product-price={finalPrice}
              data-product-image={imageUrl}
              disabled={product.stock === 0}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="9" cy="21" r="1"></circle><circle
                  cx="20"
                  cy="21"
                  r="1"></circle>
                <path
                  d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
                ></path>
              </svg>
              {product.stock > 0 ? "Añadir al carrito" : "Sin stock"}
            </button>
          </div>
        </div>
      </div>
    </div>
  </article>
</MainLayout>

<script>
  function initProductDetail() {
    const minusBtn = document.getElementById("qty-minus");
    const plusBtn = document.getElementById("qty-plus");
    const qtyInput = document.getElementById("qty-input") as HTMLInputElement;
    const addBtn = document.getElementById("add-to-cart");

    if (!qtyInput) return;

    minusBtn?.addEventListener("click", () => {
      const current = parseInt(qtyInput.value);
      if (current > 1) qtyInput.value = String(current - 1);
    });

    plusBtn?.addEventListener("click", () => {
      const max = parseInt(qtyInput.max) || 99;
      const current = parseInt(qtyInput.value);
      if (current < max) qtyInput.value = String(current + 1);
    });

    addBtn?.addEventListener("click", () => {
      const qty = parseInt(qtyInput.value);
      const cart = JSON.parse(localStorage.getItem("cart") ?? "[]") as Array<
        Record<string, string>
      >;
      const id = addBtn.getAttribute("data-product-id")!;
      const existing = cart.find((i) => i.id === id);

      if (existing) {
        existing.qty = String(parseInt(existing.qty) + qty);
      } else {
        cart.push({
          id,
          name: addBtn.getAttribute("data-product-name") ?? "",
          price: addBtn.getAttribute("data-product-price") ?? "0",
          image: addBtn.getAttribute("data-product-image") ?? "",
          qty: String(qty),
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      window.dispatchEvent(new Event("storage")); // Notificar a otros componentes

      // Feedback visual
      const originalText = addBtn.textContent;
      addBtn.textContent = `✓ Añadido (${qty})`;
      addBtn.classList.add("btn-success");

      setTimeout(() => {
        if (addBtn) {
          addBtn.textContent = originalText;
          addBtn.classList.remove("btn-success");
        }
      }, 2000);
    });
  }

  document.addEventListener("astro:page-load", initProductDetail);
</script>

<style>
  .product-detail {
    padding: 2rem 0 5rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2.5rem;
    font-size: 0.85rem;
    color: var(--text-muted);
    flex-wrap: wrap;
  }

  .breadcrumb a {
    color: var(--text-muted);
    text-decoration: none;
  }
  .breadcrumb a:hover {
    color: var(--primary);
  }
  .breadcrumb span[aria-current] {
    color: var(--text);
  }

  .product-detail__grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    align-items: start;
  }

  .product-detail__main-image {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    background: var(--surface);
    border: 1px solid var(--border);
    aspect-ratio: 1;
  }

  .product-detail__main-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .badge {
    position: absolute;
    top: 16px;
    left: 16px;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 700;
  }

  .badge--discount {
    background: var(--accent);
    color: white;
  }

  .product-detail__category {
    display: inline-block;
    color: var(--primary);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    margin-bottom: 0.75rem;
  }

  .product-detail__title {
    font-size: clamp(1.5rem, 3vw, 2.25rem);
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1.25rem;
  }

  .product-detail__pricing {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .price--main {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
  }
  .price--original {
    font-size: 1.1rem;
    color: var(--text-muted);
    text-decoration: line-through;
  }

  .product-detail__desc {
    color: var(--text-muted);
    line-height: 1.8;
    margin-bottom: 1.5rem;
  }

  .product-detail__stock {
    margin-bottom: 1.5rem;
  }
  .stock {
    font-size: 0.9rem;
    font-weight: 500;
  }
  .stock--ok {
    color: #4ade80;
  }
  .stock--out {
    color: var(--accent);
  }

  .product-detail__actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .qty-selector {
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .qty-btn {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.25rem;
    width: 40px;
    height: 48px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .qty-btn:hover {
    background: var(--surface-2);
  }

  .qty-input {
    width: 50px;
    height: 48px;
    text-align: center;
    background: none;
    border: none;
    color: var(--text);
    font-size: 1rem;
    font-weight: 600;
    -moz-appearance: textfield;
  }

  .btn-add-cart {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    padding: 0.9rem 1.75rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition:
      background 0.2s,
      transform 0.1s;
    min-width: 200px;
  }

  .btn-add-cart:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
  }
  .btn-add-cart:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .product-detail__grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }
</style>
